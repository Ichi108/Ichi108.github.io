<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Application</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #151b2b;
      --bg-card: #1a2332;
      --text-primary: #e8eaed;
      --text-secondary: #9ca3af;
      --accent: #f59e0b;
      --accent-hover: #fbbf24;
      --correct: #10b981;
      --incorrect: #ef4444;
      --border: #2d3748;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Crimson Pro', serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.7;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.03) 0%, transparent 50%);
    }

    .app-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 3rem 1.5rem;
    }

    .header {
      text-align: center;
      margin-bottom: 4rem;
      animation: fadeInDown 0.8s ease-out;
    }

    .header h1 {
      font-size: 3.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      font-size: 1.125rem;
      color: var(--text-secondary);
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 0.05em;
    }

    .upload-section {
      background: var(--bg-card);
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 3rem;
      text-align: center;
      margin-bottom: 2rem;
      transition: all 0.3s ease;
      animation: fadeIn 0.8s ease-out 0.2s backwards;
    }

    .upload-section:hover {
      border-color: var(--accent);
      background: rgba(245, 158, 11, 0.05);
    }

    .upload-section.has-file {
      border-style: solid;
      border-color: var(--correct);
      background: rgba(16, 185, 129, 0.05);
    }

    .file-input {
      display: none;
    }

    .upload-button {
      background: var(--accent);
      color: var(--bg-primary);
      border: none;
      padding: 1rem 2.5rem;
      font-size: 1.125rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', serif;
      transition: all 0.3s ease;
      display: inline-block;
    }

    .upload-button:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }

    .file-info {
      margin-top: 1.5rem;
      font-family: 'JetBrains Mono', monospace;
      color: var(--correct);
      font-size: 0.95rem;
    }

    .quiz-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 2.5rem;
      border: 1px solid var(--border);
      animation: fadeInUp 0.6s ease-out;
      position: relative;
      overflow: hidden;
    }

    .quiz-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .question-number {
      font-family: 'JetBrains Mono', monospace;
      color: var(--accent);
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.1em;
    }

    .selection-type {
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-secondary);
      font-size: 0.85rem;
      background: var(--bg-secondary);
      padding: 0.4rem 1rem;
      border-radius: 20px;
    }

    .question-text {
      font-size: 1.25rem;
      line-height: 1.8;
      margin-bottom: 2rem;
      color: var(--text-primary);
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .option-label {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1.25rem;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .option-label:hover {
      border-color: var(--accent);
      background: rgba(245, 158, 11, 0.08);
      transform: translateX(4px);
    }

    .option-label.selected {
      border-color: var(--accent);
      background: rgba(245, 158, 11, 0.12);
    }

    .option-label.correct {
      border-color: var(--correct);
      background: rgba(16, 185, 129, 0.12);
    }

    .option-label.incorrect {
      border-color: var(--incorrect);
      background: rgba(239, 68, 68, 0.12);
    }

    .option-input {
      margin-top: 0.25rem;
      cursor: pointer;
    }

    .option-text {
      flex: 1;
      font-size: 1.05rem;
    }

    .submit-button {
      background: var(--accent);
      color: var(--bg-primary);
      border: none;
      padding: 1rem 3rem;
      font-size: 1.125rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', serif;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 1.5rem;
    }

    .submit-button:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }

    .submit-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .result-section {
      margin-top: 2rem;
      padding: 2rem;
      background: var(--bg-secondary);
      border-radius: 12px;
      border-left: 4px solid var(--accent);
      animation: fadeIn 0.5s ease-out;
    }

    .result-section.correct {
      border-left-color: var(--correct);
    }

    .result-section.incorrect {
      border-left-color: var(--incorrect);
    }

    .result-title {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .result-title.correct {
      color: var(--correct);
    }

    .result-title.incorrect {
      color: var(--incorrect);
    }

    .explanation {
      font-size: 1.05rem;
      line-height: 1.8;
      color: var(--text-secondary);
    }

    .next-button {
      background: transparent;
      color: var(--accent);
      border: 2px solid var(--accent);
      padding: 1rem 3rem;
      font-size: 1.125rem;
      font-weight: 600;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Crimson Pro', serif;
      transition: all 0.3s ease;
      width: 100%;
    }

    .next-button:hover {
      background: var(--accent);
      color: var(--bg-primary);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--incorrect);
      color: var(--incorrect);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function QuizApp() {
      const [mdContent, setMdContent] = useState('');
      const [fileName, setFileName] = useState('');
      const [questions, setQuestions] = useState([]);
      const [currentQuestion, setCurrentQuestion] = useState(null);
      const [selectedAnswers, setSelectedAnswers] = useState([]);
      const [showResult, setShowResult] = useState(false);
      const [error, setError] = useState('');
      const [history, setHistory] = useState([]);
      const [view, setView] = useState('quiz'); // 'quiz' or 'history'
      const [reviewQuestion, setReviewQuestion] = useState(null);
      const [aiExplanation, setAiExplanation] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);
      const [aiEnabled, setAiEnabled] = useState(false);

      // Load history from localStorage
      useEffect(() => {
        const savedHistory = localStorage.getItem('quizHistory');
        if (savedHistory) {
          setHistory(JSON.parse(savedHistory));
        }
      }, []);

      // Save history to localStorage
      useEffect(() => {
        if (history.length > 0) {
          localStorage.setItem('quizHistory', JSON.stringify(history));
        }
      }, [history]);

      const parseMD = (content) => {
        const questionBlocks = content.split(/(?=\*\*ÂïèÈ°å\d+\*\*)/);
        const parsed = [];

        questionBlocks.forEach(block => {
          if (!block.trim()) return;

          const lines = block.split('\n').filter(line => line.trim());
          
          const questionMatch = lines[0].match(/\*\*ÂïèÈ°å(\d+)\*\*/);
          if (!questionMatch) return;

          let questionText = '';
          const options = [];
          let correctAnswer = '';
          let explanation = '';
          let isMultiSelect = false;

          let i = 1;
          while (i < lines.length && !lines[i].match(/^[A-F]\./)) {
            questionText += lines[i] + '\n';
            i++;
          }

          // Check if multi-select
          if (questionText.includes('(2„Å§ÈÅ∏Êäû)') || questionText.includes('(3„Å§ÈÅ∏Êäû)')) {
            isMultiSelect = true;
          }

          while (i < lines.length && lines[i].match(/^[A-F]\./)) {
            options.push(lines[i]);
            i++;
          }

          while (i < lines.length) {
            if (lines[i].startsWith('**Ê≠£Ëß£:')) {
              correctAnswer = lines[i].replace('**Ê≠£Ëß£:', '').replace('**', '').trim();
            } else if (lines[i].startsWith('**Ëß£Ë™¨:**')) {
              explanation = lines[i].replace('**Ëß£Ë™¨:**', '').trim();
              i++;
              while (i < lines.length && !lines[i].startsWith('**')) {
                explanation += ' ' + lines[i];
                i++;
              }
              break;
            }
            i++;
          }

          if (questionText && options.length > 0 && correctAnswer) {
            parsed.push({
              number: questionMatch[1],
              question: questionText.trim(),
              options: options,
              correctAnswer: correctAnswer,
              explanation: explanation.trim(),
              isMultiSelect: isMultiSelect
            });
          }
        });

        return parsed;
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setFileName(file.name);
        setError('');

        const reader = new FileReader();
        reader.onload = (event) => {
          const content = event.target.result;
          setMdContent(content);
          const parsedQuestions = parseMD(content);
          
          if (parsedQuestions.length === 0) {
            setError('MD„Éï„Ç°„Ç§„É´„Åã„ÇâÂïèÈ°å„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂΩ¢Âºè„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return;
          }

          setQuestions(parsedQuestions);
          loadRandomQuestion(parsedQuestions);
        };
        reader.readAsText(file);
      };

      const loadRandomQuestion = (questionList) => {
        const randomIndex = Math.floor(Math.random() * questionList.length);
        setCurrentQuestion(questionList[randomIndex]);
        setSelectedAnswers([]);
        setShowResult(false);
        setError('');
        setAiExplanation('');
        setIsGenerating(false);
      };

      const handleAnswerChange = (option) => {
        const optionLetter = option.charAt(0);

        if (currentQuestion.isMultiSelect) {
          if (selectedAnswers.includes(optionLetter)) {
            setSelectedAnswers(selectedAnswers.filter(a => a !== optionLetter));
          } else {
            setSelectedAnswers([...selectedAnswers, optionLetter]);
          }
        } else {
          setSelectedAnswers([optionLetter]);
        }
      };

      const handleSubmit = async () => {
        if (selectedAnswers.length === 0) {
          setError('ÂõûÁ≠î„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          return;
        }

        setError('');
        setShowResult(true);

        // Save to history
        const correct = isCorrect();
        const historyEntry = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          question: currentQuestion,
          selectedAnswers: selectedAnswers,
          isCorrect: correct
        };

        setHistory(prev => [historyEntry, ...prev]);

        // Generate AI explanation only if enabled
        if (aiEnabled) {
          await generateAIExplanation(
            currentQuestion,
            selectedAnswers,
            currentQuestion.correctAnswer,
            correct
          );
        }
      };

      const handleNext = () => {
        loadRandomQuestion(questions);
      };

      const generateAIExplanation = async (question, selectedAnswers, correctAnswers, isCorrect) => {
        setIsGenerating(true);
        setAiExplanation('');

        try {
          const prompt = `„ÅÇ„Å™„Åü„ÅØÂÑ™ÁßÄ„Å™ÊäÄË°ìË¨õÂ∏´„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÂïèÈ°å„Å´„Å§„ÅÑ„Å¶„ÄÅÂèóÈ®ìËÄÖ„Å´Ëß£Ë™¨„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

ÂïèÈ°å:
${question.question}

ÈÅ∏ÊäûËÇ¢:
${question.options.join('\n')}

ÂèóÈ®ìËÄÖ„ÅÆÂõûÁ≠î: ${selectedAnswers.join(', ')}
Ê≠£Ëß£: ${correctAnswers}
ÁµêÊûú: ${isCorrect ? 'Ê≠£Ëß£' : '‰∏çÊ≠£Ëß£'}

‰ª•‰∏ã„ÅÆÁÇπ„ÇíÂê´„ÇÅ„Åü‰∏ÅÂØß„Å™Ëß£Ë™¨„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö
1. „Å™„Åú„Åù„ÅÆÈÅ∏ÊäûËÇ¢„ÅåÊ≠£Ëß£„Å™„ÅÆ„Åã
2. ‰ªñ„ÅÆÈÅ∏ÊäûËÇ¢„Åå‰∏çÊ≠£Ëß£„Åß„ÅÇ„ÇãÁêÜÁî±
3. „Åì„ÅÆÂïèÈ°å„ÅßÈáçË¶Å„Å™ÊäÄË°ìÁöÑ„Éù„Ç§„É≥„Éà
${!isCorrect ? '4. ÂèóÈ®ìËÄÖ„ÅåÈñìÈÅï„Åà„ÅüÁêÜÁî±„Å®ÊîπÂñÑÁÇπ' : ''}

Ëß£Ë™¨„ÅØÁ∞°ÊΩî„Åã„Å§„Çè„Åã„Çä„ÇÑ„Åô„Åè„ÄÅ3-5ÊÆµËêΩÁ®ãÂ∫¶„Åß„Åæ„Å®„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`;

          console.log('APIÂëº„Å≥Âá∫„ÅóÈñãÂßã...');
          
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 1000,
              messages: [
                { role: "user", content: prompt }
              ],
            })
          });

          console.log('„É¨„Çπ„Éù„É≥„Çπ„Çπ„ÉÜ„Éº„Çø„Çπ:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('API„Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ:', errorText);
            throw new Error(`API Error: ${response.status} - ${errorText}`);
          }

          const data = await response.json();
          console.log('API„É¨„Çπ„Éù„É≥„Çπ:', data);
          
          if (data.content && data.content[0] && data.content[0].text) {
            setAiExplanation(data.content[0].text);
          } else if (data.error) {
            console.error('API„Ç®„É©„Éº:', data.error);
            setAiExplanation(`‚ùå „Ç®„É©„Éº: ${data.error.message || JSON.stringify(data.error)}\n\nÂÖÉ„ÅÆËß£Ë™¨„ÇíÂèÇÁÖß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
          } else {
            console.error('‰∫àÊúü„Åó„Å™„ÅÑ„É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè:', data);
            setAiExplanation('‚ùå Ëß£Ë™¨„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ\n\nÂÖÉ„ÅÆËß£Ë™¨„ÇíÂèÇÁÖß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
          }
        } catch (error) {
          console.error('AIËß£Ë™¨ÁîüÊàê„Ç®„É©„Éº:', error);
          setAiExplanation(`‚ùå „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}\n\n„Åì„ÅÆ„Ç¢„Éó„É™„ÅØ„Éñ„É©„Ç¶„Ç∂„Åã„ÇâÁõ¥Êé•Anthropic API„ÇíÂëº„Å≥Âá∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇCORS„Éù„É™„Ç∑„Éº„ÇÑ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÅÆÂïèÈ°å„ÅåÂéüÂõ†„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ\n\nÂÖÉ„ÅÆËß£Ë™¨„ÇíÂèÇÁÖß„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        } finally {
          setIsGenerating(false);
        }
      };

      const isCorrect = () => {
        const correctAnswers = currentQuestion.correctAnswer.split(',').map(a => a.trim());
        const sortedSelected = [...selectedAnswers].sort().join(',');
        const sortedCorrect = correctAnswers.sort().join(',');
        return sortedSelected === sortedCorrect;
      };

      const getOptionClass = (option) => {
        if (!showResult) {
          return selectedAnswers.includes(option.charAt(0)) ? 'selected' : '';
        }

        const optionLetter = option.charAt(0);
        const correctAnswers = currentQuestion.correctAnswer.split(',').map(a => a.trim());
        
        if (correctAnswers.includes(optionLetter)) {
          return 'correct';
        }
        
        if (selectedAnswers.includes(optionLetter)) {
          return 'incorrect';
        }

        return '';
      };

      const getStats = () => {
        if (history.length === 0) return { total: 0, correct: 0, percentage: 0 };
        const correct = history.filter(h => h.isCorrect).length;
        return {
          total: history.length,
          correct: correct,
          percentage: Math.round((correct / history.length) * 100)
        };
      };

      const handleReview = (entry) => {
        setReviewQuestion(entry);
        setView('review');
      };

      const handleBackToQuiz = () => {
        setView('quiz');
        setReviewQuestion(null);
      };

      const handleClearHistory = () => {
        if (window.confirm('Êú¨ÂΩì„Å´Â±•Ê≠¥„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
          setHistory([]);
          localStorage.removeItem('quizHistory');
        }
      };

      const getReviewOptionClass = (option, entry) => {
        const optionLetter = option.charAt(0);
        const correctAnswers = entry.question.correctAnswer.split(',').map(a => a.trim());
        const wasSelected = entry.selectedAnswers.includes(optionLetter);
        
        if (correctAnswers.includes(optionLetter)) {
          return 'correct';
        }
        
        if (wasSelected) {
          return 'incorrect';
        }

        return '';
      };

      return (
        <div className="app-container">
          <div className="header">
            <h1>Quiz Master</h1>
            <p>/ MARKDOWN QUIZ GENERATOR /</p>
          </div>

          {!mdContent ? (
            <div className="upload-section">
              <h2 style={{ marginBottom: '1rem', fontSize: '1.5rem' }}>MD„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h2>
              <p style={{ marginBottom: '2rem', color: 'var(--text-secondary)' }}>
                „ÇØ„Ç§„Ç∫ÂΩ¢Âºè„ÅÆ„Éû„Éº„ÇØ„ÉÄ„Ç¶„É≥„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
              </p>
              <label htmlFor="file-input" className="upload-button">
                „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
              </label>
              <input
                id="file-input"
                type="file"
                accept=".md,.txt"
                onChange={handleFileUpload}
                className="file-input"
              />
            </div>
          ) : (
            <>
              <div className="upload-section has-file">
                <p className="file-info">‚úì {fileName} „ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºà{questions.length}ÂïèÔºâ</p>
              </div>

              {/* View Toggle */}
              <div style={{ display: 'flex', gap: '1rem', marginBottom: '2rem' }}>
                <button 
                  className={view === 'quiz' ? 'submit-button' : 'next-button'}
                  onClick={() => setView('quiz')}
                  style={{ flex: 1 }}
                >
                  „ÇØ„Ç§„Ç∫
                </button>
                <button 
                  className={view === 'history' ? 'submit-button' : 'next-button'}
                  onClick={() => setView('history')}
                  style={{ flex: 1 }}
                >
                  Â±•Ê≠¥ ({history.length})
                </button>
              </div>

              {view === 'history' && (
                <div className="quiz-card">
                  <div className="question-header">
                    <h2 style={{ fontSize: '1.5rem', margin: 0 }}>ÂõûÁ≠îÂ±•Ê≠¥</h2>
                    {history.length > 0 && (
                      <button 
                        onClick={handleClearHistory}
                        style={{
                          background: 'transparent',
                          border: '1px solid var(--incorrect)',
                          color: 'var(--incorrect)',
                          padding: '0.5rem 1rem',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontSize: '0.9rem'
                        }}
                      >
                        Â±•Ê≠¥ÂâäÈô§
                      </button>
                    )}
                  </div>

                  {history.length === 0 ? (
                    <p style={{ textAlign: 'center', color: 'var(--text-secondary)', padding: '2rem' }}>
                      „Åæ„Å†ÂõûÁ≠îÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                    </p>
                  ) : (
                    <>
                      {/* Stats */}
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(3, 1fr)',
                        gap: '1rem',
                        marginBottom: '2rem'
                      }}>
                        <div style={{
                          background: 'var(--bg-secondary)',
                          padding: '1.5rem',
                          borderRadius: '12px',
                          textAlign: 'center'
                        }}>
                          <div style={{ fontSize: '2rem', fontWeight: '700', color: 'var(--accent)' }}>
                            {getStats().total}
                          </div>
                          <div style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>Ëß£Á≠îÊï∞</div>
                        </div>
                        <div style={{
                          background: 'var(--bg-secondary)',
                          padding: '1.5rem',
                          borderRadius: '12px',
                          textAlign: 'center'
                        }}>
                          <div style={{ fontSize: '2rem', fontWeight: '700', color: 'var(--correct)' }}>
                            {getStats().correct}
                          </div>
                          <div style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>Ê≠£Ëß£Êï∞</div>
                        </div>
                        <div style={{
                          background: 'var(--bg-secondary)',
                          padding: '1.5rem',
                          borderRadius: '12px',
                          textAlign: 'center'
                        }}>
                          <div style={{ fontSize: '2rem', fontWeight: '700', color: 'var(--accent)' }}>
                            {getStats().percentage}%
                          </div>
                          <div style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>Ê≠£Á≠îÁéá</div>
                        </div>
                      </div>

                      {/* History List */}
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                        {history.map((entry) => (
                          <div
                            key={entry.id}
                            style={{
                              background: 'var(--bg-secondary)',
                              padding: '1.5rem',
                              borderRadius: '12px',
                              borderLeft: `4px solid ${entry.isCorrect ? 'var(--correct)' : 'var(--incorrect)'}`,
                              cursor: 'pointer',
                              transition: 'all 0.3s ease'
                            }}
                            onClick={() => handleReview(entry)}
                            onMouseEnter={(e) => {
                              e.currentTarget.style.transform = 'translateX(4px)';
                              e.currentTarget.style.background = 'rgba(245, 158, 11, 0.08)';
                            }}
                            onMouseLeave={(e) => {
                              e.currentTarget.style.transform = 'translateX(0)';
                              e.currentTarget.style.background = 'var(--bg-secondary)';
                            }}
                          >
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                              <span style={{
                                fontFamily: 'JetBrains Mono, monospace',
                                fontSize: '0.85rem',
                                color: 'var(--text-secondary)'
                              }}>
                                ÂïèÈ°å {entry.question.number}
                              </span>
                              <span style={{
                                fontFamily: 'JetBrains Mono, monospace',
                                fontSize: '0.85rem',
                                color: entry.isCorrect ? 'var(--correct)' : 'var(--incorrect)',
                                fontWeight: '600'
                              }}>
                                {entry.isCorrect ? '‚úì Ê≠£Ëß£' : '‚úó ‰∏çÊ≠£Ëß£'}
                              </span>
                            </div>
                            <div style={{
                              fontSize: '1rem',
                              color: 'var(--text-primary)',
                              marginBottom: '0.5rem',
                              overflow: 'hidden',
                              textOverflow: 'ellipsis',
                              whiteSpace: 'nowrap'
                            }}>
                              {entry.question.question.split('\n')[0]}
                            </div>
                            <div style={{
                              fontSize: '0.85rem',
                              color: 'var(--text-secondary)',
                              fontFamily: 'JetBrains Mono, monospace'
                            }}>
                              {new Date(entry.timestamp).toLocaleString('ja-JP')}
                            </div>
                          </div>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              )}

              {view === 'review' && reviewQuestion && (
                <div className="quiz-card">
                  <button 
                    onClick={handleBackToQuiz}
                    style={{
                      background: 'transparent',
                      border: 'none',
                      color: 'var(--accent)',
                      cursor: 'pointer',
                      fontSize: '1rem',
                      marginBottom: '1.5rem',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem'
                    }}
                  >
                    ‚Üê Êàª„Çã
                  </button>

                  <div className="question-header">
                    <span className="question-number">ÂïèÈ°å {reviewQuestion.question.number}</span>
                    <span className="selection-type">
                      {reviewQuestion.question.isMultiSelect ? 'Ë§áÊï∞ÈÅ∏Êäû' : 'Âçò‰∏ÄÈÅ∏Êäû'}
                    </span>
                  </div>

                  <div style={{
                    padding: '1rem',
                    background: reviewQuestion.isCorrect ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                    borderRadius: '8px',
                    marginBottom: '1.5rem',
                    textAlign: 'center',
                    fontSize: '1.1rem',
                    fontWeight: '600',
                    color: reviewQuestion.isCorrect ? 'var(--correct)' : 'var(--incorrect)'
                  }}>
                    {reviewQuestion.isCorrect ? '‚úì Ê≠£Ëß£„Åß„Åó„Åü' : '‚úó ‰∏çÊ≠£Ëß£„Åß„Åó„Åü'}
                  </div>

                  <div className="question-text">{reviewQuestion.question.question}</div>

                  <div className="options">
                    {reviewQuestion.question.options.map((option, index) => (
                      <label key={index} className={`option-label ${getReviewOptionClass(option, reviewQuestion)}`}>
                        <input
                          type={reviewQuestion.question.isMultiSelect ? 'checkbox' : 'radio'}
                          className="option-input"
                          checked={reviewQuestion.selectedAnswers.includes(option.charAt(0))}
                          disabled
                        />
                        <span className="option-text">{option}</span>
                      </label>
                    ))}
                  </div>

                  <div className={`result-section ${reviewQuestion.isCorrect ? 'correct' : 'incorrect'}`}>
                    <div style={{ marginBottom: '1rem' }}>
                      <strong>Ê≠£Ëß£: {reviewQuestion.question.correctAnswer}</strong>
                    </div>
                    <div style={{ marginBottom: '1rem' }}>
                      <strong>„ÅÇ„Å™„Åü„ÅÆÂõûÁ≠î: {reviewQuestion.selectedAnswers.join(', ')}</strong>
                    </div>
                    <div className="explanation">{reviewQuestion.question.explanation}</div>
                  </div>
                </div>
              )}

              {view === 'quiz' && (
                <>
                  {error && <div className="error-message">{error}</div>}

                  {currentQuestion && (
                    <div className="quiz-card">
                      <div className="question-header">
                        <span className="question-number">ÂïèÈ°å {currentQuestion.number}</span>
                        <span className="selection-type">
                          {currentQuestion.isMultiSelect ? 'Ë§áÊï∞ÈÅ∏Êäû' : 'Âçò‰∏ÄÈÅ∏Êäû'}
                        </span>
                      </div>

                      <div className="question-text">{currentQuestion.question}</div>

                      <div className="options">
                        {currentQuestion.options.map((option, index) => (
                          <label key={index} className={`option-label ${getOptionClass(option)}`}>
                            <input
                              type={currentQuestion.isMultiSelect ? 'checkbox' : 'radio'}
                              name="quiz-option"
                              className="option-input"
                              checked={selectedAnswers.includes(option.charAt(0))}
                              onChange={() => handleAnswerChange(option)}
                              disabled={showResult}
                            />
                            <span className="option-text">{option}</span>
                          </label>
                        ))}
                      </div>

                      {!showResult ? (
                        <button 
                          className="submit-button" 
                          onClick={handleSubmit}
                          disabled={selectedAnswers.length === 0}
                        >
                          ÂõûÁ≠î„Åô„Çã
                        </button>
                      ) : (
                        <>
                          <div className={`result-section ${isCorrect() ? 'correct' : 'incorrect'}`}>
                            <div className={`result-title ${isCorrect() ? 'correct' : 'incorrect'}`}>
                              {isCorrect() ? '‚úì Ê≠£Ëß£„Åß„Åô' : '‚úó ‰∏çÊ≠£Ëß£„Åß„Åô'}
                            </div>
                            <div style={{ marginBottom: '1rem' }}>
                              <strong>Ê≠£Ëß£: {currentQuestion.correctAnswer}</strong>
                            </div>
                          </div>

                          {/* Original Explanation - Primary */}
                          {currentQuestion.explanation && (
                            <div style={{
                              marginTop: '1.5rem',
                              padding: '2rem',
                              background: 'var(--bg-secondary)',
                              borderRadius: '12px',
                              border: '1px solid var(--border)'
                            }}>
                              <h3 style={{
                                fontSize: '1.1rem',
                                fontWeight: '600',
                                color: 'var(--text-primary)',
                                marginBottom: '1rem',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem'
                              }}>
                                üìñ Ëß£Ë™¨
                              </h3>
                              <div className="explanation">{currentQuestion.explanation}</div>
                            </div>
                          )}

                          {/* AI Explanation Toggle */}
                          <div style={{
                            marginTop: '1.5rem',
                            padding: '1.5rem',
                            background: 'var(--bg-secondary)',
                            borderRadius: '12px',
                            border: '1px solid var(--border)'
                          }}>
                            <label style={{
                              display: 'flex',
                              alignItems: 'center',
                              gap: '1rem',
                              cursor: 'pointer'
                            }}>
                              <input
                                type="checkbox"
                                checked={aiEnabled}
                                onChange={(e) => {
                                  const enabled = e.target.checked;
                                  setAiEnabled(enabled);
                                  if (enabled && !aiExplanation && !isGenerating) {
                                    generateAIExplanation(
                                      currentQuestion,
                                      selectedAnswers,
                                      currentQuestion.correctAnswer,
                                      isCorrect()
                                    );
                                  }
                                }}
                                style={{ width: '20px', height: '20px', cursor: 'pointer' }}
                              />
                              <span style={{ fontSize: '1rem', color: 'var(--text-secondary)' }}>
                                ü§ñ AIËß£Ë™¨„ÇíÁîüÊàêÔºàÂÆüÈ®ìÁöÑÊ©üËÉΩ - CORS„Ç®„É©„Éº„ÅåÂá∫„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ
                              </span>
                            </label>

                            {aiEnabled && (
                              <div style={{ marginTop: '1.5rem' }}>
                                {isGenerating ? (
                                  <div style={{
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    gap: '1rem',
                                    padding: '2rem',
                                    color: 'var(--text-secondary)'
                                  }}>
                                    <div style={{
                                      width: '40px',
                                      height: '40px',
                                      border: '3px solid var(--border)',
                                      borderTop: '3px solid var(--accent)',
                                      borderRadius: '50%',
                                      animation: 'spin 1s linear infinite'
                                    }}></div>
                                    <p>AIËß£Ë™¨„ÇíÁîüÊàê‰∏≠...</p>
                                  </div>
                                ) : aiExplanation ? (
                                  <div style={{
                                    fontSize: '1.05rem',
                                    lineHeight: '1.8',
                                    color: aiExplanation.includes('‚ùå') ? 'var(--incorrect)' : 'var(--text-primary)',
                                    whiteSpace: 'pre-wrap',
                                    padding: '1rem',
                                    background: aiExplanation.includes('‚ùå') ? 'rgba(239, 68, 68, 0.1)' : 'var(--bg-card)',
                                    borderRadius: '8px'
                                  }}>
                                    {aiExplanation}
                                  </div>
                                ) : null}
                              </div>
                            )}
                          </div>

                          <button className="next-button" onClick={handleNext} style={{ marginTop: '1.5rem' }}>
                            Ê¨°„ÅÆÂïèÈ°å„Å∏
                          </button>
                        </>
                      )}
                    </div>
                  )}
                </>
              )}
            </>
          )}
        </div>
      );
    }

    ReactDOM.render(<QuizApp />, document.getElementById('root'));
  </script>
</body>
</html>